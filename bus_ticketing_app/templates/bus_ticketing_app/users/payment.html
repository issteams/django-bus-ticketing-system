{% extends 'bus_ticketing_app/users/user_layout.html' %}

{% block custom_css %}
<style>
    .payment-container {
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075);
    }

    .btn-primary {
        width: 100%;
        font-size: 16px;
    }

    .form-control {
        margin-bottom: 15px;
    }

    .summary-title {
        color: #007bff;
    }

    .payment-title {
        font-weight: bold;
        margin-bottom: 20px;
    }

    .summary-box {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075);
    }

    .summary-box h4 {
        margin-bottom: 15px;
    }

    .summary-box p {
        margin-bottom: 10px;
    }
</style>
{% endblock custom_css %}

{% block body %}
<section class="content py-5">
    <div class="container">
        <div class="row mt-3">
            <div class="col-md-8 offset-md-2">
                <div class="payment-container">
                    <h3 class="payment-title">Payment Information</h3>
                    <form id="paymentForm" action="" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="email" name="email" value="{{ user.email }}">
                        <input type="hidden" id="amount" name="amount" value="{{ amount }}">
                        <input type="hidden" id="reference" name="reference" value="{{ reference }}">
                        <input type="hidden" id="seat_number" name="seat_number" value="{{ seat_number }}">
                        <input type="hidden" id="schedule_id" name="schedule_id" value="{{ schedule.id }}">
                        <div class="summary-box">
                            <h4 class="summary-title">Booking Summary</h4>
                            <p><strong>Origin:</strong> {{ schedule.route_id.origin }}</p>
                            <p><strong>Destination:</strong> {{ schedule.route_id.destination }}</p>
                            <p><strong>Departure Time:</strong> {{ schedule.departure_time }}</p>
                            <p><strong>Arrival Time:</strong> {{ schedule.arrival_time }}</p>
                            <p><strong>Seat Number:</strong> {{ seat_number }}</p>
                            <p><strong>Total Price:</strong> ${{ amount }}</p>
                        </div>
                        <button type="button" id="pay-now" class="btn btn-primary mt-3">Pay Now</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock body %}

{% block custom_js %}
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    document.getElementById('pay-now').addEventListener('click', function (e) {
        e.preventDefault();
        
        var email = document.getElementById('email').value;
        var amount = document.getElementById('amount').value * 100; // Amount in kobo
        var reference = document.getElementById('reference').value;
        var seat_number = document.getElementById('seat_number').value;
        var schedule_id = document.getElementById('schedule_id').value;
        
        var handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}', // Replace with your Paystack public key
            email: email,
            amount: amount,
            currency: 'NGN',
            ref: reference,
            callback: function(response) {
                // This happens after the payment is completed successfully
                var reference = response.reference;
                // Make an AJAX call to your server with the reference to verify the transaction
                fetch("{% url 'bus_ticketing_app:verify_payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        reference: reference,
                        schedule_id: schedule_id,
                        seat_number: seat_number
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = "{% url 'bus_ticketing_app:payment_success' %}";
                    } else {
                        alert('Payment verification failed');
                    }
                });
            },
            onClose: function() {
                alert('Transaction was not completed, window closed.');
            }
        });
        handler.openIframe();
    });
</script>
{% endblock custom_js %}
